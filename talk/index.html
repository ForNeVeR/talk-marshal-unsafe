<html>
    <head>
        <meta charset="UTF-8"/>
        <link rel="stylesheet" href="node_modules/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="node_modules/reveal.js/css/theme/white.css">
        <link rel="stylesheet" href="node_modules/highlight.js/styles/agate.css"/>
        <style>
            img {
                border: 0 !important;
                box-shadow: none !important;
                max-height: 500px !important;
            }
            body > .reveal > .slide-number {
                left: 8px;
                right: initial;
                font-size: 6vh;
            }
        </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-markdown>
                    <script type="text/template">
                        ## На стыке управляемого и неуправляемого миров
                        ---
                        <footer style="text-align: right;">
                            by: Friedrich von Never
                            <img src="images/avatar.png"
                                 style="width: 1em;
                                        height: 1em;
                                        margin: 0;
                                        border: 0;
                                        box-shadow: none;
                                        vertical-align: sub;" /><br/>
                            https://github.com/ForNeVeR<br/>
                            https://fornever.me/<br/>
                            <img src="images/jetbrains.png"
                                 style="width: 2em; height: 2em; margin: 0; border: 0; box-shadow: none;" />
                            <img src="images/rider.png"
                                 style="width: 2em; height: 2em; margin: 0; border: 0; box-shadow: none;" /><br/>
                        </footer>
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Способы взаимодействия управляемого и неуправляемого кода

                        - C++/CLI
                        - COM
                        - P/Invoke
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## C++/CLI [0]

                        ```cpp
                        System::String ^foo = gcnew System::String("foobaz");
                        ```

                        ```cpp
                        int x = 10;
                        int %ref = x;
                        if (System::Int32::TryParse("42", ref))
                            System::Console::WriteLine(x);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## C++/CLI [1]

                        Плюсы:

                        - простое потребление заголовочных файлов и API на C
                          и C++
                        - возможность использования управляемого и
                          неуправляемого кода в одном модуле
                        - ассемблерные вставки на x86

                        Минусы:

                        - не кроссплатформенно
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Байки из склепа [0]

                        ```delphi
                        type
                         TMyCallback = function(number: Integer): Integer;

                        function DoCall(callback: TMyCallback): Integer; cdecl;
                        begin
                          Result := callback(10);
                        end;
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Байки из склепа [1]

                        ```cpp
                        // Func<int, int> ^functor
                        auto exportFunction = gcnew ExportFunction(
                            functor,
                            &Func<int, int>::Invoke);
                        auto ptr = Marshal::GetFunctionPointerForDelegate(
                            safe_cast<Delegate^>(exportFunction));

                        prepare_call(static_cast<Callback*>(ptr.ToPointer()));
                        int result = doCallFunction(&perform_wrapped_call);
                        GC::KeepAlive(exportFunction);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Байки из склепа [2]

                        ```cpp
                        Callback *CallbackInstance;
                        void prepare_call(Callback *arg) { CallbackInstance = arg; }

                        void clear_call() {
                            CallbackInstance = nullptr;
                        }

                        int __fastcall perform_wrapped_call() {
                            int real_argument;
                            __asm { mov real_argument, eax }
                            return CallbackInstance(real_argument);
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## COM

                        ```csharp
                        IComService instance = new IComService();
                        instance.HelloWorld();
                        ```

                        ```csharp
                        #if COM_LIBRARY_INSTALLED
                            IComService instance = new IComService();
                        #else
                            const string TypeGuid = "03653ea3-b63b-447b-9d26-fa86e679087b";
                            Type type = Type.GetTypeFromCLSID(Guid.Parse(TypeGuid));
                            dynamic instance = Activator.CreateInstance(type);
                        #endif

                        instance.HelloWorld();
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [0]

                        ```csharp
                        public sealed class DllImportAttribute : Attribute
                        {
                            public DllImportAttribute(string dllName) { /* ... */ }
                            public string EntryPoint;
                            public CharSet CharSet;
                            public bool SetLastError;
                            public bool ExactSpelling;
                            public CallingConvention CallingConvention;
                            public bool BestFitMapping;
                            public bool PreserveSig;
                            public bool ThrowOnUnmappableChar;
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [1]

                        ```csharp
                        [DllImport("tdjson.dll")] // → tdjson.dll      // Windows
                        [DllImport("tdjson")]     // → libtdjson.so    // Linux, .NET Core
                        [DllImport("libtdjson.so")]  // → libtdjson.so // Linux, Mono
                        [DllImport("libtdjson.dylib")] // → libtdjson.dylib // macOS

                        [DllImport("__Internal")] // Mono only
                        [DllImport("somelib.dll", EntryPoint = "#123")] // by ordinal, Windows
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [2]

                        ```csharp
                        [DllImport("StringConsumer.dll", CharSet = CharSet.Unicode)]
                        private static extern void PassUnicodeString(string str);
                        ```

                        - примитивные типы (`int`, `long`, `double` etc.)
                        - другие value types (структуры, enums)

                        - ссылочные типы (классы, делегаты)
                        - unsafe-указатели
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [3]

                        ```csharp
                        int[] x = new int[10];
                        fixed (int* ptr = x) {
                            Native.Call(ptr);
                        }
                        ```

                        - blittable / nonblittable
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [4]

                        ```csharp
                        [StructLayout(LayoutKind.Sequential)]
                        public class DBVariant {
                          public byte type;
                          public Variant Value;

                          [StructLayout(LayoutKind.Explicit)]
                          public struct Variant {
                            [FieldOffset(0)] public byte bVal;
                            [FieldOffset(0)] public byte cVal;
                            [FieldOffset(0)] public ushort wVal;
                            [FieldOffset(0)] public IntPtr pszVal;
                            [FieldOffset(0)] public ushort cchVal;
                            [FieldOffset(0)] public ByteArray ByteArrayValue;
                          }
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [5]

                        ```csharp
                        [StructLayout(LayoutKind.Sequential, Pack = 8)] // 16 bytes
                        public class DBVariant1 { public byte type; public IntPtr Pointer; }

                        [StructLayout(LayoutKind.Sequential, Pack = 1)] // 9 bytes
                        public class DBVariant2 { public byte type; public IntPtr Pointer; }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [6]

                        ```c
                        // C
                        struct X {
                          int Array[30];
                        };
                        ```

                        ```csharp
                        unsafe struct X {
                          fixed int Array[30];
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## P/Invoke [7]

                        ```csharp
                        struct Foo { public int x, y; }
                        Foo f = new Foo();
                        int offset1 = (byte*) &f.x - (byte*) &f;
                        Assert.Equal(0, offset1);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [0]

                        ```csharp
                        extern void Foo([MarshalAs(UnmanagedType.BStr)] string arg);
                        extern void Foo([MarshalAs(UnmanagedType.LPStr)] string arg);
                        extern void Foo([MarshalAs(UnmanagedType.LPWStr)] string arg);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [1]

                        ```cpp
                        #include <cwchar>
                        #include <xutility>

                        extern "C" __declspec(dllexport) void MutateString(wchar_t *string) {
                            std::reverse(string, std::wcschr(string, L'\0'));
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [2]

                        ```csharp
                        [DllImport("Project1.dll", CharSet = CharSet.Unicode)]
                        private static extern void MutateString(string foo);

                        static void Main() {
                          var myString = "Hello World 1";
                          MutateString(myString);

                          Console.WriteLine(myString);
                          Console.WriteLine("Hello World 1");
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [2]

                        ```csharp
                        [DllImport("Project1.dll", CharSet = CharSet.Unicode)]
                        private static extern void MutateString(string foo);

                        static void Main() {
                          var myString = "Hello World 1";
                          MutateString(myString);

                          Console.WriteLine(myString);          // => 1 dlroW olleH
                          Console.WriteLine("Hello World 1");   // => 1 dlroW olleH
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [3]

                        ```csharp
                        [DllImport("Project1.dll", CharSet = CharSet.Unicode)]
                        private static extern void MutateString(StringBuilder foo);

                        static void Main() {
                          var myString = new StringBuilder("Hello World 1");
                          MutateString(myString);

                          Console.WriteLine(myString.ToString()); // => 1 dlroW olleH
                          Console.WriteLine("Hello World 1");     // => Hello World 1
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [4]

                        ```cpp
                        #include <cwchar>
                        #include <xutility>

                        struct S {
                          wchar_t *field;
                        };
                        extern "C" __declspec(dllexport) void MutateStruct(S *s) {
                          MutateString(s->field);
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [5]

                        ```csharp
                        [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
                        struct S {
                            public string field;
                        }

                        [DllImport("Project1.dll", CharSet = CharSet.Unicode)]
                        private static extern void MutateStruct(ref S foo);

                        S s = new S();
                        s.field = "Hello World 2";
                        MutateStruct(ref s);

                        Console.WriteLine(s.field);         // => 2 dlroW olleH
                        Console.WriteLine("Hello World 2"); // => Hello World 2
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [6]

                        ```cpp
                        extern "C" __declspec(dllexport) void PassAnsiString(char *) {}
                        extern "C" __declspec(dllexport) void PassUnicodeString(wchar_t *) {}
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [7]

                        ```csharp
                        [Params(10, 100, 1000)]
                        public int N;

                        private string stringToPass;

                        [GlobalSetup]
                        public void Setup() => stringToPass = new string('x', N);

                        [Benchmark]
                        public void PassAnsiString() => PassAnsiString(stringToPass);

                        [Benchmark]
                        public void PassUnicodeString() => PassUnicodeString(stringToPass);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Строки [7]

                        ```
                                    Method |    N |        Mean |     Error |    StdDev |
                        ------------------ |----- |------------:|----------:|----------:|
                            PassAnsiString |   10 |    89.89 ns | 1.5052 ns | 1.2569 ns |
                         PassUnicodeString |   10 |    34.68 ns | 0.4818 ns | 0.4024 ns |
                            PassAnsiString |  100 |   167.77 ns | 3.4897 ns | 3.0935 ns |
                         PassUnicodeString |  100 |    36.37 ns | 0.7480 ns | 0.6631 ns |
                            PassAnsiString | 1000 | 1,032.29 ns | 7.2073 ns | 6.0185 ns |
                         PassUnicodeString | 1000 |    36.05 ns | 0.7446 ns | 0.9940 ns |
                        ```

                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## SafeHandle

                        ```csharp
                        // extern IntPtr CreateFile(…);
                        // extern void CloseHandle(IntPtr _);
                        IntPtr someHandle = CreateFile(…);
                        if (someHandle == IntPtr.Zero)
                            throw new Exception("Invalid handle value");
                        try {
                          // …
                        } finally {
                          CloseHandle(someHandle);
                        }
                        ```

                        ```csharp
                        class MyHandle : SafeHandleZeroOrMinusOneIsInvalid
                        {
                          public MyHandle() : base(true) { }
                          protected override bool ReleaseHandle() => CloseHandle(this.handle);
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## ICustomMarshaler

                        ```csharp
                        public interface ICustomMarshaler {
                          object MarshalNativeToManaged(IntPtr pNativeData);
                          IntPtr MarshalManagedToNative(object ManagedObj);
                          void CleanUpNativeData(IntPtr pNativeData);
                          void CleanUpManagedData(object ManagedObj);
                          int GetNativeDataSize();
                        }
                        ```

                        ```csharp
                        public class MyMarshaller : ICustomMarshaller {
                          public static ICustomMarshaler GetInstance(string cookie) =>
                            new MyMarshaller();
                          // …
                        }

                        [MarshalAs(MarshalType = "Foo.Bar.MyMarshaller",
                                   MarshalCookie = "Test")]
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Callbacks [0]

                        ```csharp
                        [UnmanagedFunctionPointer(CallingConvention.FastCall)]
                        delegate void MarshalableDelegate(int param);

                        [DllImport(…)]
                        static extern void NativeFunc(MarshalableDelegate x);

                        var myDelegate = new MarshalableDelegate(myObject.MyMethod);
                        NativeFunc(myDelegate);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Callbacks [1]

                        ```csharp
                        var myDelegate = new MarshalableDelegate(myObject.MyMethod);
                        var context = NativeFuncBegin(myDelegate);
                        // ...
                        var result = NativeFuncEnd(context);
                        GC.KeepAlive(myDelegate);
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Трюки с CIL [0]

                        ```
                        .assembly extern mscorlib { auto }
                        .assembly extern System { auto }
                        .assembly SpySharp.Hooks {}
                        .module SpySharp.Hooks.dll

                        .method assembly static native int
                            modopt ([mscorlib]System.Runtime.CompilerServices.CallConvStdcall)
                            HookProc(
                          int32 nCode,
                          native int lParam,
                          native int wParam) {
                          .vtentry 1 : 1
                          .export [1] as HookProc

                          ldc.i4.0
                          ret
                        }
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Трюки с CIL [1]

                        ```
                        .method public static pinvokeimpl("msvcrt.dll" ansi cdecl)
                        vararg int32 printf(string) cil managed preservesig {}

                        // in method:
                        .locals init(int32 i, void* pb)

                        // printf(“%2.2d : %d\n”, i, *(int*)pb);
                        ldstr "%2.2d : %d\n"
                        ldloc.0
                        ldloc.1
                        ldind.i4
                        call vararg int32 printf(string, ..., int32, int32)
                        ```
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Выводы

                        1. Не нужно бояться нативного кода.
                        2. По возможности стоит описывать код в безопасном стиле, не пользуясь
                           указателями, если можете их избежать.
                        3. `StructLayout` — наш друг.
                        4. Со строками следует обращаться крайне осторожно.
                        5. Сохраняйте ссылки на делегаты.
                        6. Тесты.
                        7. Тесты на memory layout тоже иногда полезны.
                    </script>
                </section>
                <section data-markdown>
                    <script type="text/template">
                        ## Это конец

                        <br/><br/><br/>
                        <small>Слайды доступны в репозитории https://github.com/ForNeVeR/talk-marshal-unsafe</small>
                    </script>
                </section>
            </div>
        </div>
        <script src="node_modules/reveal.js/lib/js/head.min.js"></script>
        <script src="node_modules/reveal.js/js/reveal.js"></script>
        <script>
            var isPrintMode = window.location.search.match(/print-pdf/gi);
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = isPrintMode
                ? 'node_modules/reveal.js/css/print/pdf.css'
                : 'node_modules/reveal.js/css/print/paper.css';
            document.getElementsByTagName('head')[0].appendChild(link);
            Reveal.initialize({
                dependencies: [
                    { src: 'node_modules/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'node_modules/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'node_modules/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() {
                        console.log(document.getElementsByTagName('code'));
                        hljs.initHighlightingOnLoad(); } },
                ],
                showNotes: isPrintMode,
                slideNumber: true
            });
        </script>
    </body>
</html>
